---
import path from "path";
import Hamburger from "./Hamburger.astro";
import User from "../components/NavUser.astro";
import ThemeToggle from "../components/ThemeToggle.astro";
import { Icon } from "astro-icon/components";
const links = [
  {
    name: "Home",
    url: "/",
    path: "",
    icon: "line-md:home-alt-twotone",
  },
  {
    name: "Blog",
    url: "/blog",
    path: "blog",
    icon: "line-md:text-box-multiple-twotone",
  },
  {
    name: "Discord",
    url: "/discord",
    path: "discord",
    icon: "line-md:discord",
  },
  {
    name: "Minecraft",
    url: "/minecraft",
    path: "minecraft",
    icon: "creeper",
    children: [
      { name: "About", url: "/minecraft", icon: "line-md:home-alt-twotone" },
      { name: "Players", url: "/minecraft/players", icon: "line-md:person-twotone" },
    ],
  },
  {
    name: "About",
    url: "/about",
    path: "about",
    icon: "line-md:person-twotone",
  },
];

const pathname = new URL(Astro.request.url).pathname;

// Function to check if a link is active
function isLinkActive(linkUrl: string, currentPath: string): boolean {
  if (linkUrl === '/') {
    return currentPath === '/';
  }
  return currentPath.startsWith(linkUrl);
}
---

<!-- This div is the medium-and up normal navbar.
it's hidden on small devices and replaced with a bottom-style navbar on mobile. -->
<div
  class="hidden md:flex fixed top-0 p4 z-50 w-screen max-w-screen h-16 bg-ctp-crust items-center"
>
  <a
    class="mocha hover:scale-105 hover:text-ctp-peach transition-all duration-100 flex-grow md:flex-grow-0 px-4 justify-start text-ctp-text prose-2xl font-bold"
    href="/">DivNectar</a
  >
  <div
    class="hidden md:flex md:flex-grow justify-center items-center text-ctp-text"
  >
    {
      links.map((link) => (
        <div class="relative group px-4">
          <a
            class={`
              ${isLinkActive(link.url, pathname) ? "active" : ""}
              text-ctp-text no-underline relative flex items-center gap-1
              lg:text-lg hover:text-ctp-teal transition-all duration-300 cursor-pointer
            `}
            href={link.url}
          >
            {link.name}
            {link.children && (
              <svg class="w-4 h-4 transition-transform duration-300 group-hover:rotate-180" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            )}
          </a>

          {link.children && (
            <div class="dropdown-menu absolute top-full left-0 mt-2 min-w-[200px] bg-ctp-surface0 rounded-lg shadow-lg border border-ctp-surface2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 overflow-hidden">
              {link.children.map((child) => (
                <a
                  href={child.url}
                  class={`
                    flex items-center gap-3 px-4 py-3 text-ctp-text hover:bg-ctp-surface1 hover:text-ctp-teal transition-all duration-200
                    ${isLinkActive(child.url, pathname) ? 'bg-ctp-surface1 text-ctp-sky' : ''}
                  `}
                >
                  <Icon name={child.icon} class="w-5 h-5" />
                  <span>{child.name}</span>
                </a>
              ))}
            </div>
          )}
        </div>
      ))
    }
  </div>
  <div class="flex items-center gap-2 px-4">
    <ThemeToggle />
    <Hamburger navLinks={links} />
    <User class="justify-self-end z-20 items-end" />
  </div>
</div>
<!-- Mobile submenu overlay -->
<div id="mobile-submenu-overlay" class="md:hidden fixed inset-0 bg-ctp-crust/80 backdrop-blur-sm z-40 opacity-0 invisible transition-all duration-300"></div>

<!-- Mobile submenu panel -->
<div id="mobile-submenu" class="md:hidden fixed bottom-16 left-0 right-0 bg-ctp-surface0 border-t-2 border-t-ctp-teal shadow-lg z-40 transform translate-y-full transition-transform duration-300">
  <div id="mobile-submenu-content" class="p-4 space-y-2">
    <!-- Content will be populated by JavaScript -->
  </div>
</div>

<!-- This is the mobile bottom navigation bar. -->
<div
  class="flex flex-row z-50 w-screen md:hidden bg-ctp-surface0 border-t-2 border-t-ctp-teal
        fixed bottom-0 left-0 right-0 items-center h-16 rounded-md shadow-lg"
>
  {
    links.map((link, index) => (
      link.children ? (
        <button
          class={`mobile-nav-btn flex justify-evenly self-center items-center w-full cursor-pointer transition-all duration-300 relative
                  ${isLinkActive(link.url, pathname) ? 'mobile-active' : 'hover:scale-105'}
          `}
          data-link-index={index}
          data-has-children="true"
        >
          <Icon
            class={`text-4xl transition-all duration-300
                    ${isLinkActive(link.url, pathname) ? 'text-ctp-pink scale-110' : 'text-ctp-text hover:text-ctp-sky'}
            `}
            name={link.icon}
          />
        </button>
      ) : (
        <a
          class={`flex justify-evenly self-center items-center w-full cursor-pointer transition-all duration-300
                  ${isLinkActive(link.url, pathname) ? 'mobile-active' : 'hover:scale-105'}
          `}
          href={link.url}
        >
          <Icon
            class={`text-4xl transition-all duration-300
                    ${isLinkActive(link.url, pathname) ? 'text-ctp-pink scale-110' : 'text-ctp-text hover:text-ctp-sky'}
            `}
            name={link.icon}
          />
        </a>
      )
    ))
  }
  <button
    id="theme-toggle-mobile"
    type="button"
    class="flex justify-center items-center w-full hover:scale-105 transition-all duration-300 focus:outline-none"
    aria-label="Toggle theme"
    data-umami-event="theme-toggle-click-mobile"
  >
    <svg id="theme-toggle-mobile-dark-icon" class="hidden w-9 h-9 text-ctp-text" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
      <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
    </svg>
    <svg id="theme-toggle-mobile-light-icon" class="hidden w-9 h-9 text-ctp-text" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path>
    </svg>
  </button>
</div>

<script define:vars={{ links }}>
  // Mobile submenu functionality
  function initMobileSubmenus() {
    const submenu = document.getElementById('mobile-submenu');
    const submenuOverlay = document.getElementById('mobile-submenu-overlay');
    const submenuContent = document.getElementById('mobile-submenu-content');
    const navButtons = document.querySelectorAll('.mobile-nav-btn[data-has-children="true"]');

    let isSubmenuOpen = false;

    function openSubmenu(linkIndex) {
      const link = links[linkIndex];
      if (!link.children) return;

      // Icon SVG map
      const iconSvgs = {
        'line-md:home-alt-twotone': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>',
        'line-md:person-twotone': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>',
        'line-md:person-twotone': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
      };

      // Populate submenu content
      submenuContent.innerHTML = link.children.map(child => {
        const iconSvg = iconSvgs[child.icon] || iconSvgs['line-md:person-twotone'];
        return `
          <a
            href="${child.url}"
            class="flex items-center gap-3 px-4 py-3 bg-ctp-surface1 rounded-lg text-ctp-text hover:bg-ctp-surface2 hover:text-ctp-teal transition-all duration-200 transform hover:scale-105"
          >
            ${iconSvg}
            <span class="font-medium">${child.name}</span>
          </a>
        `;
      }).join('');

      // Show submenu with animation
      submenuOverlay.classList.remove('invisible', 'opacity-0');
      submenuOverlay.classList.add('visible', 'opacity-100');
      submenu.classList.remove('translate-y-full');
      submenu.classList.add('translate-y-0');
      isSubmenuOpen = true;
    }

    function closeSubmenu() {
      submenuOverlay.classList.add('invisible', 'opacity-0');
      submenuOverlay.classList.remove('visible', 'opacity-100');
      submenu.classList.add('translate-y-full');
      submenu.classList.remove('translate-y-0');
      isSubmenuOpen = false;
    }

    // Add click handlers to nav buttons
    navButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const linkIndex = parseInt(button.dataset.linkIndex);
        if (isSubmenuOpen) {
          closeSubmenu();
        } else {
          openSubmenu(linkIndex);
        }
      });
    });

    // Close submenu when clicking overlay
    submenuOverlay.addEventListener('click', closeSubmenu);

    // Close submenu on navigation
    document.addEventListener('astro:after-swap', closeSubmenu);
  }

  function initMobileThemeToggle() {
    const themeToggleBtn = document.getElementById('theme-toggle-mobile');
    const themeToggleDarkIcon = document.getElementById('theme-toggle-mobile-dark-icon');
    const themeToggleLightIcon = document.getElementById('theme-toggle-mobile-light-icon');

    if (!themeToggleBtn) return;

    // Function to update icon visibility
    function updateIcon() {
      if (document.documentElement.classList.contains('dark')) {
        themeToggleLightIcon?.classList.remove('hidden');
        themeToggleDarkIcon?.classList.add('hidden');
      } else {
        themeToggleLightIcon?.classList.add('hidden');
        themeToggleDarkIcon?.classList.remove('hidden');
      }
    }

    // Initial icon update
    updateIcon();

    // Toggle theme on button click
    themeToggleBtn.addEventListener('click', () => {
      const isDark = document.documentElement.classList.contains('dark');

      if (isDark) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }

      updateIcon();

      // Track theme change with umami
      if (window.umami) {
        window.umami.track('theme-change', {
          theme: isDark ? 'light' : 'dark',
          source: 'manual-toggle-mobile'
        });
      }

      // Dispatch custom event for other components (like Giscus)
      window.dispatchEvent(new CustomEvent('themeChanged'));
    });

    // Update icon after page transitions
    document.addEventListener('astro:after-swap', updateIcon);
  }

  // Initialize on page load
  initMobileThemeToggle();
  initMobileSubmenus();

  // Reinitialize after page transitions
  document.addEventListener('astro:after-swap', initMobileThemeToggle);
  document.addEventListener('astro:after-swap', initMobileSubmenus);
</script>

<!-- this div just matches the height of the navbar
to keep the content from going below it on page load. -->
<!-- throw extra margin on the bottom to make content look nice -->
<!-- <div class="h-16"></div> -->

<style>
  /* Desktop active link with animated underline */
  .active {
    color: var(--ctp-sky);
  }

  .active::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, var(--ctp-pink), var(--ctp-mauve));
    border-radius: 2px;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      width: 0%;
      opacity: 0;
    }
    to {
      width: 100%;
      opacity: 1;
    }
  }

  /* Mobile active indicator */
  .mobile-active {
    position: relative;
  }

  .mobile-active::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background: var(--ctp-pink);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }
    50% {
      opacity: 0.7;
      transform: translateX(-50%) scale(1.2);
    }
  }
</style>
