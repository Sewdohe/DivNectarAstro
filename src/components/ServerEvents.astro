---
const backend_url = import.meta.env.BACKEND_URL;
---

<div>
  <h2 class="text-3xl font-extrabold text-ctp-pink">Server Events</h2>
  <ul id="events-list"></ul>
</div>

<script define:vars={{ backend_url }}>
  const ws = new WebSocket("wss://backend.divnectar.com");
  const eventsList = document.getElementById("events-list");

  // Fetch the last events when the page loads
  fetch('http://localhost:4477/api' + "/skyblock/events")
    .then((response) => response.json())
    .then((events) => {
      events.forEach((event) => {
        const listItem = document.createElement("li");
        listItem.classList.add("my-2");
        switch (event.eventType) {
          case "PlayerChat":
            listItem.innerHTML = `<span class="font-extrabold rounded-md mx-2 bg-ctp-mantle p-2">${event.player.displayName}:</span> ${event.message}`;
            break;
          case "PlayerJoin":
            listItem.innerHTML = `<span class="font-extrabold">${event.player.displayName}</span> joined the server`;
            break;
          case "PlayerLeave":
            listItem.innerHTML = `<span class="font-extrabold">${event.player.displayName}</span> left the server`;
            break;
          default:
            listItem.innerHTML = `<span class="font-extrabold">${event.player.displayName}</span> event occurred`;
            break;
        }
        eventsList.append(listItem);
      });
    });

  ws.onmessage = (event) => {
    const newEvent = JSON.parse(event.data);
    const listItem = document.createElement("li");
    listItem.classList.add("my-2");
    console.log(newEvent);
    switch (newEvent.eventType) {
      case "PlayerChat":
        listItem.innerHTML = `<span class="font-extrabold rounded-md mx-2 bg-ctp-mantle p-2">${newEvent.player.displayName}:</span> ${newEvent.message}`;
        break;
      case "PlayerJoin":
        listItem.innerHTML = `<span class="font-extrabold">${newEvent.player.displayName}</span> left the server`;
        break;
      case "PlayerLeave":
        listItem.innerHTML = `<span class="font-extrabold">${newEvent.player.displayName}</span> left the server`;
        break;
      default:
        listItem.innerHTML = `<span class="font-extrabold">${newEvent.player.displayName}</span> left the server`;
        break;
    }
    eventsList?.append(listItem);
  };

  window.addEventListener("beforeunload", () => {
    ws.close();
  });
</script>
