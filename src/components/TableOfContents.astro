---
// Table of Contents component
// Automatically generates TOC from h2 and h3 headings
---

<!-- Desktop: Sidebar TOC -->
<aside id="toc-container" class="toc-wrapper">
  <div class="toc-header">
    <h2 class="text-lg font-bold text-ctp-text">Table of Contents</h2>
  </div>
  <nav id="toc-nav" class="toc-nav">
    <!-- TOC will be generated here by JavaScript -->
  </nav>
</aside>

<!-- Mobile: FAB Button -->
<button
  id="toc-fab"
  class="toc-fab"
  aria-label="Open table of contents"
  data-umami-event="toc-fab-open"
>
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
  </svg>
</button>

<!-- Mobile: TOC Modal Overlay -->
<div id="toc-modal" class="toc-modal">
  <div class="toc-modal-backdrop"></div>
  <div class="toc-modal-content">
    <div class="toc-modal-header">
      <h2 class="text-xl font-bold text-ctp-text">Table of Contents</h2>
      <button
        id="toc-close"
        class="toc-close-btn"
        aria-label="Close table of contents"
        data-umami-event="toc-modal-close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <nav id="toc-nav-mobile" class="toc-nav-mobile">
      <!-- TOC will be duplicated here for mobile -->
    </nav>
  </div>
</div>

<script>
  function initTOC() {
    const tocNav = document.getElementById('toc-nav');
    const tocNavMobile = document.getElementById('toc-nav-mobile');
    const tocFab = document.getElementById('toc-fab');
    const tocModal = document.getElementById('toc-modal');
    const tocClose = document.getElementById('toc-close');
    const pageContent = document.getElementById('page-content');

    if (!tocNav || !pageContent) return;

    // Get all h2 and h3 headings
    const headings = pageContent.querySelectorAll('h2, h3');

    if (headings.length === 0) {
      // Hide TOC if no headings
      document.getElementById('toc-container')?.classList.add('hidden');
      tocFab?.classList.add('hidden');
      return;
    }

    // Generate TOC HTML
    let tocHTML = '<ul class="space-y-2">';
    headings.forEach((heading, index) => {
      const level = heading.tagName.toLowerCase();
      const text = heading.textContent || '';
      const id = heading.id || `heading-${index}`;

      // Add ID to heading if it doesn't have one
      if (!heading.id) {
        heading.id = id;
      }

      const indent = level === 'h3' ? 'ml-4' : '';
      const fontSize = level === 'h3' ? 'text-sm' : 'text-base';

      tocHTML += `
        <li class="${indent}">
          <a href="#${id}" class="toc-link ${fontSize} text-ctp-subtext0 hover:text-ctp-sky transition-colors block py-1" data-target="${id}">
            ${text}
          </a>
        </li>
      `;
    });
    tocHTML += '</ul>';

    // Set HTML for both desktop and mobile
    tocNav.innerHTML = tocHTML;
    if (tocNavMobile) {
      tocNavMobile.innerHTML = tocHTML;
    }

    // Smooth scroll to heading on click (both desktop and mobile)
    const allTocLinks = document.querySelectorAll('.toc-link');
    allTocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('data-target');
        const target = document.getElementById(targetId || '');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          history.pushState(null, '', `#${targetId}`);

          // Close modal on mobile after clicking
          tocModal?.classList.remove('toc-modal-open');
          document.body.style.overflow = '';
        }
      });
    });

    // Highlight active section on scroll
    const observerOptions = {
      rootMargin: '-20% 0px -80% 0px',
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const id = entry.target.id;
        const tocLinks = document.querySelectorAll(`a[data-target="${id}"]`);

        if (entry.isIntersecting) {
          // Remove active class from all links
          document.querySelectorAll('.toc-link').forEach(l => {
            l.classList.remove('toc-active');
          });
          // Add active class to current link (both desktop and mobile)
          tocLinks.forEach(link => link?.classList.add('toc-active'));
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));

    // Mobile FAB click - open modal
    tocFab?.addEventListener('click', () => {
      tocModal?.classList.add('toc-modal-open');
      document.body.style.overflow = 'hidden';
    });

    // Close button click
    tocClose?.addEventListener('click', () => {
      tocModal?.classList.remove('toc-modal-open');
      document.body.style.overflow = '';
    });

    // Click backdrop to close
    tocModal?.querySelector('.toc-modal-backdrop')?.addEventListener('click', () => {
      tocModal?.classList.remove('toc-modal-open');
      document.body.style.overflow = '';
    });
  }

  // Initialize on page load
  initTOC();

  // Reinitialize after page transitions
  document.addEventListener('astro:after-swap', initTOC);
</script>

<style>
  /* Desktop TOC Sidebar */
  .toc-wrapper {
    position: sticky;
    top: 5rem;
    max-height: calc(100vh - 6rem);
    overflow-y: auto;
    background: var(--ctp-crust);
    border: 1px solid var(--ctp-surface2);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 768px) {
    .toc-wrapper {
      display: none;
    }
  }

  .toc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--ctp-surface2);
  }

  .toc-nav {
    max-height: 70vh;
    overflow-y: auto;
  }

  /* Mobile FAB Button */
  .toc-fab {
    display: none;
    position: fixed;
    bottom: 5rem;
    right: 1rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--ctp-pink);
    color: var(--ctp-base);
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    z-index: 40;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .toc-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  }

  .toc-fab:active {
    transform: scale(0.95);
  }

  @media (max-width: 768px) {
    .toc-fab {
      display: flex;
    }
  }

  /* Mobile TOC Modal */
  .toc-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 50;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  @media (max-width: 768px) {
    .toc-modal {
      display: block;
    }
  }

  .toc-modal-open {
    opacity: 1;
    pointer-events: all;
  }

  .toc-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .toc-modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    background: var(--ctp-crust);
    border: 2px solid var(--ctp-surface2);
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    transition: transform 0.3s ease;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .toc-modal-open .toc-modal-content {
    transform: translate(-50%, -50%) scale(1);
  }

  .toc-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--ctp-surface2);
  }

  .toc-close-btn {
    background: transparent;
    border: none;
    color: var(--ctp-text);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .toc-close-btn:hover {
    background: var(--ctp-surface0);
    color: var(--ctp-pink);
  }

  .toc-nav-mobile {
    overflow-y: auto;
    flex: 1;
    padding-right: 0.5rem;
  }

  /* Active link styling */
  .toc-active {
    color: var(--ctp-pink) !important;
    font-weight: 600;
    border-left: 2px solid var(--ctp-pink);
    padding-left: 0.5rem;
    margin-left: -0.5rem;
  }

  /* Scrollbar styling */
  .toc-nav::-webkit-scrollbar,
  .toc-nav-mobile::-webkit-scrollbar {
    width: 4px;
  }

  .toc-nav::-webkit-scrollbar-track,
  .toc-nav-mobile::-webkit-scrollbar-track {
    background: var(--ctp-surface0);
    border-radius: 4px;
  }

  .toc-nav::-webkit-scrollbar-thumb,
  .toc-nav-mobile::-webkit-scrollbar-thumb {
    background: var(--ctp-surface2);
    border-radius: 4px;
  }

  .toc-nav::-webkit-scrollbar-thumb:hover,
  .toc-nav-mobile::-webkit-scrollbar-thumb:hover {
    background: var(--ctp-overlay0);
  }
</style>
