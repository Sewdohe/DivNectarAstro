---
import Navigation from "../components/Navigation.astro";
import { SEO } from "astro-seo";
var { title, description, image } = Astro.props;
import { Tooltips } from "astro-tooltips";

// use our global styles
import "../styles/global.css";

//
import { ClientRouter } from "astro:transitions";
import { url } from "inspector";

const currentRoute = Astro.url.pathname;
console.log("currentRoute:", currentRoute);

async function generateOgImage(path: string) {
  try {
    const response = await fetch(
      `${import.meta.env.BACKEND_URL}/og-image?url=https://divnectar.com${path}`
    );
    if (!response.ok) {
      throw new Error("Failed to generate OG image");
    }
    const screenshotUrl = await response.text();
    console.log("Generated OG image:", screenshotUrl);
  } catch (error) {
    console.error("Error generating OG image:", error);
  }
}

async function handleOGImage() {
	try {
      const response = await fetch(
        `${import.meta.env.BACKEND_URL}/check-og-image?path=${encodeURIComponent(currentRoute)}`
      );
      if (response.ok) {
        const data = await response.json();
        if (data.exists) {
					console.log('Image exists already!', data)
          image.url = data.url;
          image.alt = `Screenshot of https://divnectar.com${currentRoute}`;
        } else {
					console.log('Image doesnt exist, defaulting...')
					console.log('we will generate on the next run')
					generateOgImage(currentRoute);
          image = {
						url: 'https://divnectar.com/site-logo.webp',
						alt: 'DivNectar Logo'
					}
        }
      } else {
				console.log('error checking OG image. Something wrong with API.')
				image = {
						url: 'https://divnectar.com/site-logo.webp',
						alt: 'DivNectar Logo'
					}
        // await generateOgImage(currentRoute);
      }
    } catch (error) {
      console.error("Error checking OG image:", error);
    }
}

if (!image) { // if no image use the check OG image API
	image = {
		url: 'https://divnectar.com/site-logo.webp',
		alt: 'DivNectar Logo'
	}
  await handleOGImage();
}

console.log("image:", image);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.png" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <Tooltips interactive={false} delay={[15, 14000]} />
    <meta name="generator" content={Astro.generator} />
    <ClientRouter />
    <script
      type="text/partytown"
      data-website-id="18091b9b-ce52-4b2b-8372-32b854387db7"
      src="https://analytics.divnectar.com/script.js"></script>
    <title>DivNectar</title>
    <SEO
      title={title}
      description={description}
      openGraph={{
        basic: {
          title: title,
          type: "image",
          image: image.url,
        },
      }}
      twitter={{
        creator: "@Sewdohe",
      }}
      extend={{
        // extending the default link tags
        link: [{ rel: "icon", href: "/favicon.ico" }],
        // extending the default meta tags
        meta: [
          {
            name: "twitter:image",
            content: image.url,
          },
          {
            name: "twitter:title",
            content: description,
          },
          { name: "twitter:description", content: description },
        ],
      }}
    />
  </head>
  <body
    class="bg-ctp-base container m-0 p-0 text-ctp-text prose prose-catpuccin w-full lg:prose-xl"
  >
    <Navigation transition:persist />
    <div id="content" class="px-3 w-full lg:px-10">
      <slot />
    </div>
  </body>
</html>

<style>
  html,
  head,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
