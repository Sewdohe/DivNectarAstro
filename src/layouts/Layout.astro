---
import Navigation from "../components/Navigation.astro";
import { SEO } from "astro-seo";
var { title, description, image, center, direction, topPadding } = Astro.props;

import { Tooltips } from "astro-tooltips";
import LinkTracker from "../components/LinkTracker.astro";

// use our global styles
import "../styles/catppuccin-theme.css";
import "../styles/global.css";
import "../styles/mocha.css";
//
import { ClientRouter } from "astro:transitions";
import { url } from "inspector";

const currentRoute = Astro.url.pathname;
// console.log("currentRoute:", currentRoute);

async function generateOgImage(path: string) {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 40000); // 40 second timeout

    const response = await fetch(
      `${import.meta.env.BACKEND_URL}/og-image?url=https://divnectar.com${path}`,
      { signal: controller.signal }
    );

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Failed to generate OG image: ${response.status} - ${errorText}`);
    }

    const screenshotUrl = await response.text();
    console.log("Successfully generated OG image:", screenshotUrl);
    return screenshotUrl;
  } catch (error) {
    if (error instanceof Error) {
      if (error.name === 'AbortError') {
        console.error("OG image generation timed out");
      } else {
        console.error("Error generating OG image:", error.message);
      }
    }
    return null;
  }
}

async function handleOGImage() {
  try {
    if (!import.meta.env.BACKEND_URL) {
      console.warn("BACKEND_URL not configured, using default logo");
      return;
    }

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout for check

    const response = await fetch(
      `${import.meta.env.BACKEND_URL}/check-og-image?path=${encodeURIComponent(currentRoute)}`,
      { signal: controller.signal }
    );

    clearTimeout(timeoutId);

    if (response.ok) {
      const data = await response.json();
      if (data.exists && data.url) {
        image.url = data.url;
        image.alt = `Screenshot of https://divnectar.com${currentRoute}`;
      } else {
        // Image doesn't exist or is stale - trigger generation for next visit
        console.log(`OG image ${data.reason === 'stale' ? 'is stale' : 'does not exist'}, triggering generation...`);
        generateOgImage(currentRoute); // Fire and forget
        image = {
          url: "https://divnectar.com/site-logo.webp",
          alt: "DivNectar Logo",
        };
      }
    } else {
      console.error(`Error checking OG image: ${response.status} ${response.statusText}`);
      image = {
        url: "https://divnectar.com/site-logo.webp",
        alt: "DivNectar Logo",
      };
    }
  } catch (error) {
    if (error instanceof Error && error.name === 'AbortError') {
      console.error("OG image check timed out");
    } else {
      console.error("Error checking OG image:", error);
    }
    // Fallback to default logo on any error
    image = {
      url: "https://divnectar.com/site-logo.webp",
      alt: "DivNectar Logo",
    };
  }
}

if (!image) {
  // if no image use the check OG image API
  image = {
    url: "https://divnectar.com/site-logo.webp",
    alt: "DivNectar Logo",
  };
  await handleOGImage();
}

// console.log("image:", image);
---

<!doctype html>
<html lang="en" class="dark">
  <head>
    <script is:inline>
      // Function to apply theme
      function applyTheme(trackChange = false) {
        const theme = (() => {
          if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
            return localStorage.getItem('theme');
          }
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
          }
          return 'light';
        })();

        if (theme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
          document.documentElement.classList.add('dark');
        }

        window.localStorage.setItem('theme', theme);

        // Track theme change if explicitly requested
        if (trackChange && window.umami) {
          window.umami.track('theme-change', { theme: theme });
        }
      }

      // Apply theme immediately on page load
      applyTheme();

      // Reapply theme after Astro page transitions
      document.addEventListener('astro:after-swap', applyTheme);

      // Listen for system theme changes and track them
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        const newTheme = e.matches ? 'dark' : 'light';
        if (newTheme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
          document.documentElement.classList.add('dark');
        }
        window.localStorage.setItem('theme', newTheme);

        // Track system theme change
        if (window.umami) {
          window.umami.track('theme-change', { theme: newTheme, source: 'system' });
        }
      });
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.png" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta name="theme-color" content="#89dceb" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1e1e2e" media="(prefers-color-scheme: dark)">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="DivNectar - FOSS software and Minecraft"
      href={`https://divnectar.com/blog/feed.xml`}
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <Tooltips interactive={true} delay={[15, 14000]} />
    <meta name="generator" content={Astro.generator} />
    <ClientRouter />
    <script
      type="text/partytown"
      data-website-id="18091b9b-ce52-4b2b-8372-32b854387db7"
      src="https://analytics.divnectar.com/script.js"></script>
    <title>DivNectar</title>
    <SEO
      title={title}
      description={description}
      openGraph={{
        basic: {
          title: title,
          type: "image",
          image: image.url,
        },
      }}
      twitter={{
        creator: "@Sewdohe",
      }}
      extend={{
        // extending the default link tags
        link: [{ rel: "icon", href: "/favicon.ico" }],
        // extending the default meta tags
        meta: [
          {
            name: "twitter:image",
            content: image.url,
          },
          {
            name: "twitter:title",
            content: description,
          },
          { name: "twitter:description", content: description },
        ],
      }}
    />
    <!-- This slot of for any JSONLD components to mount inside -->
    <slot name="head" />
  </head>
  <body class=`bg-ctp-base container m-0 p-0 md:w-screen text-ctp-text w-full`>
    <LinkTracker />
    <Navigation transition:persist />
    <div
      id="content"
      class=`flex ${direction && 'flex-col'} ${center && 'justify-center'} w-full md:w-screen`
    >
    <div class="navbar-spacer h-4 md:h-20 md:flex" />
      <slot />
    </div>
  </body><div></div>
</html>

<style>
  html,
  head,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }

  /* Paper/Linen texture background - like old Apple Notes */
  body {
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.03;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 2px, var(--ctp-overlay0) 2px, var(--ctp-overlay0) 4px),
      repeating-linear-gradient(90deg, transparent, transparent 2px, var(--ctp-overlay0) 2px, var(--ctp-overlay0) 4px);
    background-size: 100px 100px;
  }

  body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.015;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
  }

  /* Ensure content is above the texture */
  body > * {
    position: relative;
    z-index: 1;
  }

  .tippy-box[data-theme="default"] {
    background-color: #181825;
    color: #bac2de;
    border: 1px solid black;
    border-radius: 8px;
    padding: 0.5rem;
    word-wrap: break-word;
  }
</style>
