---
import { Icon } from "astro-icon/components";
import { GET as getUser } from "./api/oauth/get-user";
import Navigation from "../components/Navigation.astro";
import "../styles/catppuccin-theme.css";
import "../styles/global.css";
import "../styles/mocha.css";
import Layout from "../layouts/Layout.astro";

const userId = Astro.cookies.get("userId")?.value ?? "0";
let user: any = null;
let isAdmin = false;

if (userId !== "0") {
  const response = await getUser({
    request: new Request(`http://localhost/api/oauth/get-user?id=${userId}`),
  });

  if (response && typeof response.json === 'function') {
    user = await response.json();
    isAdmin = user && user.username === "sewdohe";
  }
}

const title = "Admin Dashboard - DivNectar";
---
<Layout title={title} description="Admin dashboard for managing the DivNectar Minecraft server and website.">
    {!isAdmin ? (
      <div class="w-full px-4 py-16 text-center">
        <div class="max-w-md mx-auto bg-ctp-surface0 rounded-lg p-8 border-2 border-ctp-red mt-20">
          <Icon name="mdi:shield-alert" class="w-16 h-16 text-ctp-red mx-auto mb-4" />
          <h1 class="text-3xl font-bold text-ctp-red mb-4">Access Denied</h1>
          <p class="text-ctp-subtext0 mb-6">
            You do not have permission to access this page.
          </p>
          <a
            href="/"
            class="inline-flex items-center gap-2 px-6 py-3 bg-ctp-mauve hover:bg-ctp-pink text-ctp-base rounded-lg font-bold transition-colors"
          >
            <Icon name="line-md:arrow-left" class="w-5 h-5" />
            <span>Back to Home</span>
          </a>
        </div>
      </div>
    ) : (
      <div class="w-full min-h-screen bg-ctp-base">
        <!-- Header -->
        <div class="bg-ctp-crust border-b-2 border-ctp-red">
          <div class="w-full px-4 py-6">
            <div class="flex items-center justify-between max-w-screen-2xl mx-auto">
              <div class="flex items-center gap-3">
                <Icon name="mdi:shield-crown" class="w-10 h-10 text-ctp-red" />
                <div>
                  <h1 class="text-3xl font-bold text-ctp-text">Admin Dashboard</h1>
                  <p class="text-sm text-ctp-subtext0">Full server control panel</p>
                </div>
              </div>
              <a
                href="/"
                class="inline-flex mx-8 items-center gap-2 px-4 py-2 bg-ctp-surface1 hover:bg-ctp-surface2 text-ctp-text rounded-lg transition-colors"
              >
                <Icon name="line-md:home-twotone" class="w-5 h-5" />
                <span class="hidden md:inline">Home</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="w-full px-4 py-8">
          <div class="max-w-screen-2xl mx-auto">
            <!-- Tab Navigation -->
            <div class="bg-ctp-surface0 rounded-t-lg border-2 border-b-0 border-ctp-surface2">
              <div class="flex flex-wrap gap-2 p-4">
                <button
                  data-tab="players"
                  class="tab-button active flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all"
                >
                  <Icon name="mdi:account-group" class="w-5 h-5" />
                  <span>Player Manager</span>
                </button>
                <button
                  data-tab="users"
                  class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all"
                >
                  <Icon name="mdi:account-key" class="w-5 h-5" />
                  <span>Site Users</span>
                </button>
                <button
                  data-tab="console"
                  class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all"
                >
                  <Icon name="mdi:console" class="w-5 h-5" />
                  <span>Command Runner</span>
                </button>
              </div>
            </div>

            <!-- Tab Content Container -->
            <div class="bg-ctp-surface0 rounded-b-lg border-2 border-ctp-surface2 p-6 min-h-[600px]">
              <!-- Player Manager Tab -->
              <div id="tab-players" class="tab-content">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-2xl font-bold text-ctp-text">Minecraft Players</h2>
                  <button
                    id="refresh-players"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-ctp-mauve hover:bg-ctp-pink text-ctp-base rounded-lg font-semibold transition-colors"
                  >
                    <Icon name="mdi:refresh" class="w-5 h-5" />
                    <span>Refresh</span>
                  </button>
                </div>

                <!-- Search and Filter -->
                <div class="mb-6">
                  <input
                    type="text"
                    id="player-search"
                    placeholder="Search players by username..."
                    class="w-full px-4 py-2 bg-ctp-base border border-ctp-surface2 rounded-lg text-ctp-text placeholder-ctp-subtext0 focus:outline-none focus:ring-2 focus:ring-ctp-mauve"
                  />
                </div>

                <!-- Loading State -->
                <div id="players-loading" class="text-center py-12">
                  <Icon name="line-md:loading-loop" class="w-12 h-12 text-ctp-mauve mx-auto mb-4" />
                  <p class="text-ctp-subtext0">Loading players...</p>
                </div>

                <!-- Error State -->
                <div id="players-error" class="hidden text-center py-12">
                  <Icon name="mdi:alert-circle" class="w-12 h-12 text-ctp-red mx-auto mb-4" />
                  <p class="text-ctp-red font-semibold mb-2">Failed to load players</p>
                  <p class="text-ctp-subtext0" id="players-error-message"></p>
                </div>

                <!-- Players Table -->
                <div id="players-container" class="hidden overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="border-b-2 border-ctp-surface2">
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Player</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Status</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Balance</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Playtime</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="players-table-body">
                      <!-- Populated by JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Site Users Tab -->
              <div id="tab-users" class="tab-content hidden">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-2xl font-bold text-ctp-text">OAuth Users</h2>
                  <button
                    id="refresh-users"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-ctp-mauve hover:bg-ctp-pink text-ctp-base rounded-lg font-semibold transition-colors"
                  >
                    <Icon name="mdi:refresh" class="w-5 h-5" />
                    <span>Refresh</span>
                  </button>
                </div>

                <!-- Loading State -->
                <div id="users-loading" class="text-center py-12">
                  <Icon name="line-md:loading-loop" class="w-12 h-12 text-ctp-mauve mx-auto mb-4" />
                  <p class="text-ctp-subtext0">Loading users...</p>
                </div>

                <!-- Error State -->
                <div id="users-error" class="hidden text-center py-12">
                  <Icon name="mdi:alert-circle" class="w-12 h-12 text-ctp-red mx-auto mb-4" />
                  <p class="text-ctp-red font-semibold mb-2">Failed to load users</p>
                  <p class="text-ctp-subtext0" id="users-error-message"></p>
                </div>

                <!-- Users Table -->
                <div id="users-container" class="hidden overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="border-b-2 border-ctp-surface2">
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Discord User</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Email</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Discord ID</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Minecraft Link</th>
                        <th class="text-left py-3 px-4 text-ctp-text font-semibold">Created</th>
                      </tr>
                    </thead>
                    <tbody id="users-table-body">
                      <!-- Populated by JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Command Runner Tab -->
              <div id="tab-console" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-ctp-text mb-6">Server Console & Commands</h2>

                <!-- Console Output -->
                <div class="mb-6">
                  <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-semibold text-ctp-text">Console Output</label>
                    <button
                      id="clear-console"
                      class="text-sm text-ctp-subtext0 hover:text-ctp-text transition-colors"
                    >
                      Clear
                    </button>
                  </div>
                  <div
                    id="console-output"
                    class="bg-ctp-crust rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm border border-ctp-surface2"
                  >
                    <div class="text-ctp-green">
                      [INFO] Admin console ready
                    </div>
                    <div class="text-ctp-subtext0">
                      [INFO] Type commands below to execute on the server
                    </div>
                  </div>
                </div>

                <!-- Command Input -->
                <div>
                  <label for="command-input" class="block text-sm font-semibold text-ctp-text mb-2">
                    Execute Command
                  </label>
                  <form id="command-form" class="flex gap-2">
                    <input
                      type="text"
                      id="command-input"
                      placeholder="e.g., list, say Hello, give @p diamond 64"
                      class="flex-1 px-4 py-3 bg-ctp-base border border-ctp-surface2 rounded-lg text-ctp-text placeholder-ctp-subtext0 focus:outline-none focus:ring-2 focus:ring-ctp-mauve font-mono"
                      autocomplete="off"
                    />
                    <button
                      type="submit"
                      class="inline-flex items-center gap-2 px-6 py-3 bg-ctp-mauve hover:bg-ctp-pink text-ctp-base rounded-lg font-bold transition-colors"
                    >
                      <Icon name="mdi:send" class="w-5 h-5" />
                      <span>Execute</span>
                    </button>
                  </form>
                </div>

                <!-- Common Commands -->
                <div class="mt-6">
                  <p class="text-sm font-semibold text-ctp-text mb-3">Quick Commands</p>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button
                      class="quick-command px-4 py-2 bg-ctp-surface1 hover:bg-ctp-surface2 text-ctp-text rounded-lg text-sm transition-colors"
                      data-command="list"
                    >
                      List Players
                    </button>
                    <button
                      class="quick-command px-4 py-2 bg-ctp-surface1 hover:bg-ctp-surface2 text-ctp-text rounded-lg text-sm transition-colors"
                      data-command="save-all"
                    >
                      Save World
                    </button>
                    <button
                      class="quick-command px-4 py-2 bg-ctp-surface1 hover:bg-ctp-surface2 text-ctp-text rounded-lg text-sm transition-colors"
                      data-command="time set day"
                    >
                      Set Day
                    </button>
                    <button
                      class="quick-command px-4 py-2 bg-ctp-surface1 hover:bg-ctp-surface2 text-ctp-text rounded-lg text-sm transition-colors"
                      data-command="weather clear"
                    >
                      Clear Weather
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    )}
    </Layout>

<script>
  const BACKEND_URL = import.meta.env.DEV
    ? 'http://localhost:4477'
    : 'https://backend.divnectar.com';

  // Tab Management
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabName = (button as HTMLElement).dataset.tab;

      // Update button states
      tabButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('bg-ctp-mauve', 'text-ctp-base');
        btn.classList.add('bg-ctp-surface1', 'text-ctp-text', 'hover:bg-ctp-surface2');
      });
      button.classList.add('active');
      button.classList.remove('bg-ctp-surface1', 'text-ctp-text', 'hover:bg-ctp-surface2');
      button.classList.add('bg-ctp-mauve', 'text-ctp-base');

      // Update content visibility
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`tab-${tabName}`)?.classList.remove('hidden');
    });
  });

  // Set initial active state
  const activeButton = document.querySelector('.tab-button.active');
  if (activeButton) {
    activeButton.classList.add('bg-ctp-mauve', 'text-ctp-base');
    activeButton.classList.remove('bg-ctp-surface1', 'text-ctp-text', 'hover:bg-ctp-surface2');
  }

  // Player Manager Functions
  async function loadPlayers() {
    const loading = document.getElementById('players-loading');
    const error = document.getElementById('players-error');
    const container = document.getElementById('players-container');
    const tbody = document.getElementById('players-table-body');

    if (loading) loading.classList.remove('hidden');
    if (error) error.classList.add('hidden');
    if (container) container.classList.add('hidden');

    try {
      const response = await fetch(`${BACKEND_URL}/api/admin/players`, {
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Failed to fetch players');
      }

      const data = await response.json();
      const players = data.players || [];

      if (tbody) {
        tbody.innerHTML = players.map((player: any) => {
          const playtime = formatPlaytime(player.total_playtime || 0);
          const balance = formatBalance(player.balance || 0);
          const statusClass = player.is_online ? 'bg-ctp-green' : 'bg-ctp-surface2';
          const statusText = player.is_online ? 'Online' : 'Offline';

          return `
            <tr class="border-b border-ctp-surface2 hover:bg-ctp-surface1 transition-colors player-row" data-username="${player.username?.toLowerCase() || ''}">
              <td class="py-3 px-4">
                <div class="flex items-center gap-3">
                  <img
                    src="https://mc-heads.net/avatar/${player.player_uuid}/32"
                    alt="${player.username}"
                    class="w-8 h-8 rounded"
                  />
                  <span class="text-ctp-text font-semibold">${player.username || 'Unknown'}</span>
                </div>
              </td>
              <td class="py-3 px-4">
                <span class="inline-flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full ${statusClass}"></span>
                  <span class="text-ctp-subtext0">${statusText}</span>
                </span>
              </td>
              <td class="py-3 px-4 text-ctp-text">${balance}</td>
              <td class="py-3 px-4 text-ctp-text">${playtime}</td>
              <td class="py-3 px-4">
                <div class="flex gap-2">
                  <button
                    onclick="executePlayerCommand('kick ${player.username}')"
                    class="px-3 py-1 bg-ctp-red hover:bg-ctp-maroon text-white rounded text-sm transition-colors"
                    title="Kick player"
                  >
                    Kick
                  </button>
                  <button
                    onclick="executePlayerCommand('tp ${player.username} @p')"
                    class="px-3 py-1 bg-ctp-mauve hover:bg-ctp-pink text-white rounded text-sm transition-colors"
                    title="Teleport to you"
                  >
                    TP
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      if (loading) loading.classList.add('hidden');
      if (container) container.classList.remove('hidden');
    } catch (err: unknown) {
      console.error('Error loading players:', err);
      if (loading) loading.classList.add('hidden');
      if (error) {
        error.classList.remove('hidden');
        const errorMsg = document.getElementById('players-error-message');
        if (errorMsg) errorMsg.textContent = err instanceof Error ? err.message : 'Unknown error';
      }
    }
  }

  // Site Users Functions
  async function loadUsers() {
    const loading = document.getElementById('users-loading');
    const error = document.getElementById('users-error');
    const container = document.getElementById('users-container');
    const tbody = document.getElementById('users-table-body');

    if (loading) loading.classList.remove('hidden');
    if (error) error.classList.add('hidden');
    if (container) container.classList.add('hidden');

    try {
      const response = await fetch(`${BACKEND_URL}/api/admin/users`, {
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Failed to fetch users');
      }

      const data = await response.json();
      const users = data.users || [];

      if (tbody) {
        tbody.innerHTML = users.map((user: any) => {
          const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Unknown';
          const minecraftLink = user.minecraftLinked
            ? `<span class="text-ctp-green">âœ“ ${user.minecraftName || 'Linked'}</span>`
            : '<span class="text-ctp-subtext0">Not linked</span>';

          // Construct Discord avatar URL from user ID and avatar hash
          const avatarUrl = user.avatar
            ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
            : '';

          return `
            <tr class="border-b border-ctp-surface2 hover:bg-ctp-surface1 transition-colors">
              <td class="py-3 px-4">
                <div class="flex items-center gap-3">
                  ${avatarUrl ? `<img src="${avatarUrl}" alt="${user.username}" class="w-8 h-8 rounded-full" />` : ''}
                  <span class="text-ctp-text font-semibold">${user.username || 'Unknown'}</span>
                </div>
              </td>
              <td class="py-3 px-4 text-ctp-subtext0">${user.email || 'N/A'}</td>
              <td class="py-3 px-4 text-ctp-subtext0 font-mono text-sm">${user.id}</td>
              <td class="py-3 px-4">${minecraftLink}</td>
              <td class="py-3 px-4 text-ctp-subtext0">${createdDate}</td>
            </tr>
          `;
        }).join('');
      }

      if (loading) loading.classList.add('hidden');
      if (container) container.classList.remove('hidden');
    } catch (err: unknown) {
      console.error('Error loading users:', err);
      if (loading) loading.classList.add('hidden');
      if (error) {
        error.classList.remove('hidden');
        const errorMsg = document.getElementById('users-error-message');
        if (errorMsg) errorMsg.textContent = err instanceof Error ? err.message : 'Unknown error';
      }
    }
  }

  // Command Runner Functions
  async function executeCommand(command: string) {
    const output = document.getElementById('console-output');
    if (!output) return;

    // Add command to output
    const commandLine = document.createElement('div');
    commandLine.className = 'text-ctp-blue mb-1';
    commandLine.textContent = `> ${command}`;
    output.appendChild(commandLine);

    try {
      const response = await fetch(`${BACKEND_URL}/api/admin/command`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ command })
      });

      const data = await response.json();

      const resultLine = document.createElement('div');
      if (response.ok) {
        resultLine.className = 'text-ctp-green mb-2';
        resultLine.textContent = data.response || 'Command executed successfully';
      } else {
        resultLine.className = 'text-ctp-red mb-2';
        resultLine.textContent = `Error: ${data.error || 'Failed to execute command'}`;
      }
      output.appendChild(resultLine);
    } catch (err: unknown) {
      const errorLine = document.createElement('div');
      errorLine.className = 'text-ctp-red mb-2';
      errorLine.textContent = `Error: ${err instanceof Error ? err.message : 'Unknown error'}`;
      output.appendChild(errorLine);
    }

    // Scroll to bottom
    output.scrollTop = output.scrollHeight;
  }

  // Global function for player actions
  (window as any).executePlayerCommand = function(command: string) {
    if (confirm(`Execute command: ${command}?`)) {
      executeCommand(command);
    }
  };

  // Event Listeners
  document.getElementById('refresh-players')?.addEventListener('click', loadPlayers);
  document.getElementById('refresh-users')?.addEventListener('click', loadUsers);

  document.getElementById('command-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('command-input') as HTMLInputElement;
    if (input && input.value.trim()) {
      executeCommand(input.value.trim());
      input.value = '';
    }
  });

  document.querySelectorAll('.quick-command').forEach(button => {
    button.addEventListener('click', () => {
      const command = (button as HTMLElement).dataset.command;
      if (command) executeCommand(command);
    });
  });

  document.getElementById('clear-console')?.addEventListener('click', () => {
    const output = document.getElementById('console-output');
    if (output) {
      output.innerHTML = '<div class="text-ctp-green">[INFO] Console cleared</div>';
    }
  });

  // Player search
  document.getElementById('player-search')?.addEventListener('input', (e) => {
    const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
    const rows = document.querySelectorAll('.player-row');
    rows.forEach(row => {
      const username = (row as HTMLElement).dataset.username || '';
      if (username.includes(searchTerm)) {
        (row as HTMLElement).style.display = '';
      } else {
        (row as HTMLElement).style.display = 'none';
      }
    });
  });

  // Helper functions
  function formatPlaytime(milliseconds: number): string {
    const hours = Math.floor(milliseconds / 3600000);
    const minutes = Math.floor((milliseconds % 3600000) / 60000);
    if (hours > 0) {
      return `${hours}h ${minutes}m`;
    }
    return `${minutes}m`;
  }

  function formatBalance(balance: number): string {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(balance || 0);
  }

  // Load initial data
  loadPlayers();
  loadUsers();
</script>

<style>
  .tab-button:not(.active) {
    @apply bg-ctp-surface1 text-ctp-text hover:bg-ctp-surface2;
  }

  #console-output::-webkit-scrollbar {
    width: 8px;
  }

  #console-output::-webkit-scrollbar-track {
    background: var(--ctp-surface0);
    border-radius: 4px;
  }

  #console-output::-webkit-scrollbar-thumb {
    background: var(--ctp-surface2);
    border-radius: 4px;
  }

  #console-output::-webkit-scrollbar-thumb:hover {
    background: var(--ctp-overlay0);
  }
</style>
