---
import axios from 'axios';
import moment from 'moment';
import { URLSearchParams } from 'url';
import Layout from '../layouts/Layout.astro';

// Function to handle OAuth response
const handleAuthResponse = async (searchParams: URLSearchParams) => {
  const token = searchParams.get('access_token');
  const expires = searchParams.get('expires_in');

  if (token && expires) {
    try {
      const response = await axios.get('https://discord.com/api/users/@me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (typeof window !== 'undefined') {
        window.localStorage.setItem('discord_user', JSON.stringify(response.data));
        window.localStorage.setItem('expires', moment().add(2, 'days').format());
        window.location.href = window.localStorage.getItem('afterLogin') || '/';
        console.log(response.data)
      }
    } catch (error) {
      console.error('Error fetching user data:', error);
    }
  }
};

// Get URL search parameters on the server side
const searchParams = new URLSearchParams(Astro.url.search);
await handleAuthResponse(searchParams);
console.log('done loading')

const image = {
	url: "https://user-images.githubusercontent.com/5182256/131216951-8f74f425-f775-463d-a11b-0e01ad9fce8d.png",
	alt: "DivNectar Logo",
}
---

<Layout title="DivNectar - Auth" description="Login with Discord" image={image}>
  <div class="flex flex-col items-center">
    <h1 class="text-4xl font-bold">Auth</h1>
    <p class="text-lg">This is the auth page.</p>
  </div>
</Layout>
