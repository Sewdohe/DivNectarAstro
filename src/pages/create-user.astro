---
import Layout from "../layouts/Layout.astro";

const title = "DivNectar - New User";
const description = 'thank you for regisering with DivNectar.';
const image = {
	url: "https://user-images.githubusercontent.com/5182256/131216951-8f74f425-f775-463d-a11b-0e01ad9fce8d.png",
	alt: "DivNectar Logo",
}

const id = Astro.url.searchParams.get('id') || '';

const userCookie = !!Astro.cookies.get('userId')

export async function GET({ request, params, url }: { request: Request, params: any, url: URL }) {
    const userId = url.searchParams.get('userId');
    let user = null;
    let error = null;

    if (userId) {
        // Set cookie on the frontend
        Astro.cookies.set('userId', userId, { path: '/', secure: true, maxAge: 7 * 24 * 60 * 60 });

        try {
            const response = await fetch(`https://divnectar.com/api/get-user?id=${userId}`);
            if (response.ok) {
                user = await response.json();
            } else {
                error = 'Error fetching user data';
            }
        } catch (err) {
            //@ts-ignore
            error = err.message;
        }
    } else {
        // Check for existing cookie
        const cookieUserId = Astro.cookies.get('userId');
        if (cookieUserId) {
            try {
                const response = await fetch(`https://divnectar.com/api/get-user?id=${cookieUserId}`);
                if (response.ok) {
                    user = await response.json();
                } else {
                    error = 'Error fetching user data';
                }
            } catch (err) {
                //@ts-ignore
                error = err.message;
            }
        } else {
            error = 'User ID not found in URL or cookies';
        }
    }

    return {
        props: {
            user,
            error,
        },
    };
}

const { user, error } = Astro.props;
---

<Layout title={title} description={description} image={image}>
  <p>Your account was created successfully.</p>
  <p>Your user ID is: {id}</p>
  {error ? (
        <p>{error}</p>
    ) : user ? (
        <div>
            <h1>{user.username}</h1>
            <img src={`https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`} alt="User Avatar" />
        </div>
    ) : (
        <p>Loading...</p>
    )}
</Layout>

<script data-userCookie={userCookie}>
  console.log('userCookie', userCookie);
</script>