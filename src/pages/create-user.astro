---
import Layout from "../layouts/Layout.astro";

const title = "DivNectar - New User";
const description = 'thank you for regisering with DivNectar.';
const image = {
	url: "https://user-images.githubusercontent.com/5182256/131216951-8f74f425-f775-463d-a11b-0e01ad9fce8d.png",
	alt: "DivNectar Logo",
}

export async function GET({ request }: { request: Request }) {
    const cookies = request.headers.get('cookie');
    const userIdMatch = cookies && cookies.match(/userId=([^;]+)/);
    const userId = userIdMatch ? userIdMatch[1] : null;

    console.log('Cookies:', cookies);
    console.log('User ID:', userId);

    let user = null;
    let error = null;

    if (userId) {
        try {
            const response = await fetch(`https://divnectar.com/api/get-user?id=${userId}`);
            console.log('API Response Status:', response.status);
            if (response.ok) {
                user = await response.json();
                console.log('User Data:', user);
            } else {
                error = 'Error fetching user data';
                console.log('API Error:', error);
            }
        } catch (err) {
            //@ts-ignore
            error = err.message;
            console.log('Fetch Error:', error);
        }
    } else {
        error = 'User ID not found in cookies';
        console.log('Cookie Error:', error);
    }

    return {
        props: {
            user,
            error,
        },
    };
}

const { user, error } = Astro.props;
---

<Layout title={title} description={description} image={image}>
  <p>Your account was created successfully.</p>
  {error ? (
        <p>{error}</p>
    ) : user ? (
        <div>
            <h1>{user.username}</h1>
            <img src={`https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`} alt="User Avatar" />
        </div>
    ) : (
        <p>Loading...</p>
    )}
</Layout>