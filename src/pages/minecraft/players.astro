---
import Layout from '../../layouts/Layout.astro';
import { getPlayerGlossary } from '../../db/queries';

const players = await getPlayerGlossary();

// Helper function to format playtime
function formatPlaytime(milliseconds: number): string {
  const hours = Math.floor(milliseconds / 3600000);
  const minutes = Math.floor((milliseconds % 3600000) / 60000);
  if (hours > 0) {
    return `${hours}h ${minutes}m`;
  }
  return `${minutes}m`;
}

// Helper function to format date
function formatDate(timestamp: number): string {
  return new Date(timestamp).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
}

// Helper function to get Minecraft avatar URL
function getMinecraftAvatar(uuid: string): string {
  // Remove dashes from UUID for mc-heads.net
  const cleanUuid = uuid.replace(/-/g, '');
  return `https://mc-heads.net/avatar/${cleanUuid}/128`;
}

// Helper function to format balance
function formatBalance(balance: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(balance || 0);
}
---

<Layout title="Player Glossary - DivNectar">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-ctp-text mb-2">Player Glossary</h1>
    <p class="text-ctp-subtext0 mb-8">Browse all players on the DivNectar server</p>

    <!-- Search and Filter Controls -->
    <div class="bg-ctp-surface0 rounded-lg p-6 mb-8 shadow-lg">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Search -->
        <div>
          <label for="search" class="block text-sm font-medium text-ctp-text mb-2">
            Search Players
          </label>
          <input
            type="text"
            id="search"
            placeholder="Search by username..."
            class="w-full px-4 py-2 bg-ctp-base border border-ctp-surface2 rounded-lg text-ctp-text placeholder-ctp-subtext0 focus:outline-none focus:ring-2 focus:ring-ctp-mauve"
          />
        </div>

        <!-- Status Filter -->
        <div>
          <label for="status-filter" class="block text-sm font-medium text-ctp-text mb-2">
            Status
          </label>
          <select
            id="status-filter"
            class="w-full px-4 py-2 bg-ctp-base border border-ctp-surface2 rounded-lg text-ctp-text focus:outline-none focus:ring-2 focus:ring-ctp-mauve"
          >
            <option value="all">All Players</option>
            <option value="online">Online Only</option>
            <option value="offline">Offline Only</option>
          </select>
        </div>

        <!-- Sort -->
        <div>
          <label for="sort" class="block text-sm font-medium text-ctp-text mb-2">
            Sort By
          </label>
          <select
            id="sort"
            class="w-full px-4 py-2 bg-ctp-base border border-ctp-surface2 rounded-lg text-ctp-text focus:outline-none focus:ring-2 focus:ring-ctp-mauve"
          >
            <option value="last_login">Last Seen</option>
            <option value="playtime">Playtime</option>
            <option value="balance">Balance</option>
            <option value="first_joined">Join Date</option>
            <option value="username">Username</option>
          </select>
        </div>
      </div>

      <!-- Player Count -->
      <div class="mt-4 text-sm text-ctp-subtext0">
        Showing <span id="visible-count">{players.length}</span> of <span id="total-count">{players.length}</span> players
      </div>
    </div>

    <!-- Player Grid -->
    <div id="player-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {players.map((player) => (
        <div
          class="player-card bg-ctp-surface0 rounded-lg p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105"
          data-username={player.username.toLowerCase()}
          data-is-online={player.is_online}
          data-playtime={player.total_playtime}
          data-balance={player.balance || 0}
          data-first-joined={player.first_joined}
        >
          <!-- Player Header -->
          <div class="flex items-center gap-4 mb-4">
            <!-- Avatar -->
            <div class="relative">
              <img
                src={getMinecraftAvatar(player.player_uuid)}
                alt={player.username}
                class="w-16 h-16 rounded-lg shadow-md"
                loading="lazy"
              />
              <!-- Online Indicator -->
              {player.is_online ? (
                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-ctp-green rounded-full border-2 border-ctp-surface0 online-indicator" title="Online">
                  <div class="w-full h-full bg-ctp-green rounded-full animate-ping opacity-75"></div>
                </div>
              ) : null}
            </div>

            <!-- Username -->
            <div class="flex-1 min-w-0">
              <h3 class="text-lg font-bold text-ctp-text truncate">
                {player.username}
              </h3>
              {player.discord_id && (
                <div class="flex items-center gap-1 text-sm text-ctp-mauve">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.120.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                  </svg>
                  <span class="text-xs">Linked</span>
                </div>
              )}
            </div>
          </div>

          <!-- Stats Grid -->
          <div class="space-y-3">
            <!-- Playtime -->
            <div class="flex justify-between items-center">
              <span class="text-sm text-ctp-subtext0">Playtime</span>
              <span class="text-sm font-semibold text-ctp-text">
                {formatPlaytime(player.total_playtime || 0)}
              </span>
            </div>

            <!-- Balance -->
            <div class="flex justify-between items-center">
              <span class="text-sm text-ctp-subtext0">Balance</span>
              <span class="text-sm font-semibold text-ctp-green">
                {formatBalance(player.balance)}
              </span>
            </div>

            <!-- K/D Ratio -->
            <div class="flex justify-between items-center">
              <span class="text-sm text-ctp-subtext0">K/D</span>
              <span class="text-sm font-semibold text-ctp-text">
                {player.total_kills || 0}/{player.total_deaths || 0}
              </span>
            </div>

            <!-- Parkour Score -->
            {player.parkour_score && (
              <div class="flex justify-between items-center">
                <span class="text-sm text-ctp-subtext0">Parkour</span>
                <span class="text-sm font-semibold text-ctp-mauve">
                  {player.parkour_score} pts
                </span>
              </div>
            )}

            <!-- First Joined -->
            <div class="flex justify-between items-center">
              <span class="text-sm text-ctp-subtext0">Joined</span>
              <span class="text-sm font-semibold text-ctp-text">
                {player.first_joined ? formatDate(player.first_joined) : 'Unknown'}
              </span>
            </div>

            <!-- Last Seen (if offline) -->
            {!player.is_online && player.last_logoff && (
              <div class="flex justify-between items-center">
                <span class="text-sm text-ctp-subtext0">Last Seen</span>
                <span class="text-sm font-semibold text-ctp-subtext1">
                  {formatDate(player.last_logoff)}
                </span>
              </div>
            )}
          </div>
        </div>
      ))}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-12">
      <p class="text-xl text-ctp-subtext0">No players found matching your criteria.</p>
    </div>
  </div>
</Layout>

<script>
  // Search, filter, and sort functionality
  const searchInput = document.getElementById('search') as HTMLInputElement;
  const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;
  const sortSelect = document.getElementById('sort') as HTMLSelectElement;
  const playerGrid = document.getElementById('player-grid') as HTMLDivElement;
  const visibleCount = document.getElementById('visible-count') as HTMLSpanElement;
  const noResults = document.getElementById('no-results') as HTMLDivElement;

  function filterAndSortPlayers() {
    const searchTerm = searchInput.value.toLowerCase();
    const status = statusFilter.value;
    const sortBy = sortSelect.value;

    const cards = Array.from(document.querySelectorAll('.player-card')) as HTMLElement[];

    // Filter
    let visibleCards = cards.filter(card => {
      const username = card.dataset.username || '';
      const isOnline = card.dataset.isOnline === '1';

      const matchesSearch = username.includes(searchTerm);
      const matchesStatus =
        status === 'all' ||
        (status === 'online' && isOnline) ||
        (status === 'offline' && !isOnline);

      const visible = matchesSearch && matchesStatus;
      card.style.display = visible ? 'block' : 'none';
      return visible;
    });

    // Sort
    visibleCards.sort((a, b) => {
      switch (sortBy) {
        case 'username':
          return (a.dataset.username || '').localeCompare(b.dataset.username || '');
        case 'playtime':
          return Number(b.dataset.playtime) - Number(a.dataset.playtime);
        case 'balance':
          return Number(b.dataset.balance) - Number(a.dataset.balance);
        case 'first_joined':
          return Number(a.dataset.firstJoined) - Number(b.dataset.firstJoined);
        case 'last_login':
        default:
          return 0; // Already sorted by last login in SQL
      }
    });

    // Reorder DOM
    visibleCards.forEach(card => {
      playerGrid.appendChild(card);
    });

    // Update count
    visibleCount.textContent = visibleCards.length.toString();

    // Show/hide no results message
    if (visibleCards.length === 0) {
      playerGrid.classList.add('hidden');
      noResults.classList.remove('hidden');
    } else {
      playerGrid.classList.remove('hidden');
      noResults.classList.add('hidden');
    }
  }

  searchInput.addEventListener('input', () => {
    if (searchInput.value.length > 0 && window.umami) {
      window.umami.track('players-search-used');
    }
    filterAndSortPlayers();
  });

  statusFilter.addEventListener('change', () => {
    if (window.umami) {
      window.umami.track('players-filter-status', { status: statusFilter.value });
    }
    filterAndSortPlayers();
  });

  sortSelect.addEventListener('change', () => {
    if (window.umami) {
      window.umami.track('players-sort-changed', { sortBy: sortSelect.value });
    }
    filterAndSortPlayers();
  });
</script>

<style>
  @keyframes ping {
    75%, 100% {
      transform: scale(2);
      opacity: 0;
    }
  }

  .online-indicator > div {
    animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
  }
</style>
