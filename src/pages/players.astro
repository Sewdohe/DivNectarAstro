---
import axios from "axios";
import { getPlayerData } from "../db/queries";
import Layout from "../layouts/Layout.astro";

const title = "DivNectar";
const description = "DivNectar - FOSS software and the Minecrafts.";
const backend_url = import.meta.env.BACKEND_URL;


const players = await getPlayerData();
// players.map(async (player) => {
//   const data = {
//     uuid: player.uuid,
//     message: "player_online",
//   };
//   var onlineStatus = await axios
//     .post(`${backend_url}/skyblock/player/online`, data)
//   player.onlineStatus = onlineStatus.data;
//   return player;
// })
const updatedPlayers = await Promise.all(players.map(async (player) => {
  const data = {
    uuid: player.uuid,
    message: "player_online",
  };
  try {
    const response = await axios.post(`${backend_url}/skyblock/player/online`, data);
    player.onlineStatus = response.data;
  } catch (error) {
    console.error(`Error fetching online status for player ${player.uuid}:`, error);
    player.onlineStatus = 'no'; // Default to offline if there's an error
  }
  return player;
}));
---

<Layout title={title} description={description}>
  <div
    class="grid px-8 md:px-4 w-full grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"
  >
    {
      updatedPlayers.map((player) => {
        console.log(player)
        return (
          <div id="player-card">
            <a
              href={`/players/${player.uuid}`}
              class="flex flex-col items-center rounded-lg shadow md:flex-row md:max-w-xl dark:border-gray-700 dark:bg-ctp-crust dark:hover:bg-ctp-mantle"
            >
              <img
                class="object-contain my-2 aspect-auto w-full rounded-t-lg h-48 md:w-48 md:rounded-none md:rounded-s-lg"
                src={`https://mc-heads.net/body/${player.uuid}`}
                alt=""
              />
              <div class="flex flex-row justify-between p-4 leading-normal">
                <h5 class="mb-2 prose-xl font-bold tracking-tight text-white">
                  {player.username}
                </h5>
                <span
                  class={`w-4 h-4 ml-4 mb-2 text-ctp-text rounded-full ${
                    player.onlineStatus == "yes" ? "bg-ctp-green" : "bg-ctp-red"
                  }`}
                />
              </div>
            </a>
          </div>
        );
      })
    }
  </div>
</Layout>
